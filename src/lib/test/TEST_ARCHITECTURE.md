# Test Architecture

## Directory Structure

```
src/lib/test/
├── TEST_ARCHITECTURE.md # Documentation of test architecture
├── index.ts            # Main entry point, re-exports everything
├── utils.ts            # Core utility functions (getTestSong, getTestGame, etc.)
├── fixtures/           # Test data and utilities (auto-generated)
│   ├── index.ts       # Re-exports all test data
│   ├── models.ts      # Domain model test data (auto-generated)
│   ├── genius.ts      # Genius API test data and types (auto-generated)
│   └── spotify.ts     # Spotify API test data and types (auto-generated)
└── test-env/          # Test environment setup
    ├── db.ts          # Database setup and utilities
    ├── environment.ts # Common environment setup
    ├── integration.ts # Integration test setup/cleanup + context
    └── unit.ts        # Unit test setup/cleanup + context
```

## Main Exports (`@/lib/test`)

### Test Data and Utilities
```typescript
import { 
  // Test Data
  modelData,     // Domain models (songs, games, guesses)
  spotifyData,   // Spotify API responses
  geniusData,    // Genius API responses

  // Test Utilities
  getTestSong,   // Get typed Song test data
  getTestGame,   // Get typed Game test data
  getTestGuess,  // Get typed Guess test data
  getTestGameWithSong,  // Get game with its associated song
  getTestGuessesForGame,// Get all guesses for a game
  SONG_KEYS,     // Type-safe song keys
  GAME_KEYS,     // Type-safe game keys
  TEST_DATA      // Commonly used test data
} from '@/lib/test';
```

### Test Environment
```typescript
import { 
  // Setup/Cleanup Functions
  setupUnitTest,         // Setup unit test context
  setupIntegrationTest,  // Setup integration test context
  cleanupUnitTest,       // Cleanup unit test context
  cleanupIntegrationTest,// Cleanup integration test context

  // Context Types
  type UnitTestContext,        // Unit test context type
  type IntegrationTestContext  // Integration test context type
} from '@/lib/test';
```

### Mock Clients
```typescript
import { 
  SpotifyClientMock,  // Mock Spotify client
  GeniusClientMock    // Mock Genius client
} from '@/lib/test';
```

## File Purposes

### Core Files
- `index.ts`: Re-exports everything needed for tests
- `utils.ts`: Core utility functions for working with test data
- `TEST_ARCHITECTURE.md`: This documentation file

### Fixtures
- `fixtures/index.ts`: Re-exports all test data and types
- `fixtures/models.ts`: Auto-generated domain model test data
- `fixtures/genius.ts`: Genius API test data and response types
- `fixtures/spotify.ts`: Spotify API test data and response types

**Important**: All fixture files are auto-generated by `scripts/generate-fixtures.ts`. Do not edit them manually.
To update fixtures, modify the generator script and run:
```bash
pnpm generate-fixtures
```

### Test Environment
- `test-env/environment.ts`: Common environment setup
  - Environment variables
  - Global test configuration
  - Shared utilities

- `test-env/db.ts`: Database setup and utilities
  - Database connection management
  - Test database setup/cleanup
  - Transaction helpers

- `test-env/unit.ts`: Unit test setup/cleanup and context
  - `setupUnitTest`: Creates mocked services and clients
  - `cleanupUnitTest`: Resets all mocks
  - `UnitTestContext`: Type for unit test context

- `test-env/integration.ts`: Integration test setup/cleanup and context
  - `setupIntegrationTest`: Creates real services with test data
  - `cleanupIntegrationTest`: Cleans up test data
  - `IntegrationTestContext`: Type for integration test context

## Common Usage Patterns

### Unit Tests
```typescript
describe('MyTest', () => {
  let context: UnitTestContext;

  beforeEach(() => {
    context = setupUnitTest();
  });

  afterEach(() => {
    cleanupUnitTest();
  });

  test('my test', () => {
    const song = getTestSong(SONG_KEYS.PARTY_IN_THE_U_S_A_);
    // ... test implementation
  });
});
```

### Integration Tests
```typescript
describe('MyIntegrationTest', () => {
  let context: IntegrationTestContext;

  beforeEach(async () => {
    context = await setupIntegrationTest();
  });

  afterEach(async () => {
    await cleanupIntegrationTest();
  });

  test('my test', async () => {
    const game = getTestGame(GAME_KEYS.PARTY_IN_THE_U_S_A_);
    // ... test implementation
  });
});
```

## Import Rules

1. Always import from `@/lib/test` - it re-exports everything you need
2. Never import directly from subdirectories like `@/lib/test/fixtures`
3. All test data and utilities live in either:
   - `fixtures/` for test data and types (auto-generated)
   - `utils.ts` for core utility functions
   - `test-env/` for test environment setup
4. Never edit fixture files manually - use the generator
5. use spotify types from `@spotify/web-api-ts-sdk`