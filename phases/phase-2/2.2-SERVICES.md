# Milestone 2.2: External Services

## Goals
- Implement Spotify API integration
- Implement Genius API integration
- Set up error handling and retries
- Create service tests

## Tasks

### 1. Spotify Service
- [ ] Authentication Setup
  - [ ] Create src/lib/spotify/auth.ts
  - [ ] Implement token management
  - [ ] Handle token refresh
  - [ ] Add error handling

- [ ] API Client Implementation
  - [ ] Create src/lib/spotify/client.ts
  - [ ] Implement playlist search
  - [ ] Implement track fetching
  - [ ] Add rate limiting
  - [ ] Add retry mechanism

- [ ] Type Safety
  - [ ] Use SDK types
  - [ ] Add runtime type validation with Zod
  - [ ] Add error types

### 2. Genius Service
- [ ] Authentication Setup
  - [ ] Create src/lib/genius/auth.ts
  - [ ] Implement token management
  - [ ] Add error handling

- [ ] API Client Implementation
  - [ ] Create src/lib/genius/client.ts
  - [ ] Implement lyrics fetching
  - [ ] Implement song search
  - [ ] Add rate limiting
  - [ ] Add retry mechanism

- [ ] Type Safety
  - [ ] Create/use type definitions
  - [ ] Add runtime type validation
  - [ ] Add error types

### 3. Error Handling
- [ ] Create src/lib/errors.ts
  - [ ] Define error classes
  - [ ] Add error codes
  - [ ] Add error messages

- [ ] Implement Error Recovery
  - [ ] Add retry strategies
  - [ ] Add fallback mechanisms
  - [ ] Add logging

### 4. Rate Limiting
- [ ] Create src/lib/rate-limit.ts
  - [ ] Implement token bucket algorithm
  - [ ] Add configurable limits
  - [ ] Add queue mechanism

### 5. Testing
- [ ] Unit Tests
  - [ ] Test Spotify client
  - [ ] Test Genius client
  - [ ] Test error handling
  - [ ] Test rate limiting

- [ ] Integration Tests
  - [ ] Test API interactions
  - [ ] Test error recovery
  - [ ] Test rate limiting
  - [ ] Test concurrent requests

- [ ] Mock Services
  - [ ] Create mock responses
  - [ ] Add test utilities
  - [ ] Add fixtures

### 6. Documentation
- [ ] API Documentation
  - [ ] Document endpoints
  - [ ] Document types
  - [ ] Add examples

- [ ] Error Documentation
  - [ ] Document error codes
  - [ ] Document recovery strategies
  - [ ] Add troubleshooting guide

## Verification
- [ ] Spotify API working
- [ ] Genius API working
- [ ] Error handling effective
- [ ] Rate limiting working
- [ ] Tests passing
- [ ] Documentation complete

## Dependencies
```bash
# Already have Spotify SDK
pnpm add axios
pnpm add zod
pnpm add -D jest @types/jest ts-jest
``` 