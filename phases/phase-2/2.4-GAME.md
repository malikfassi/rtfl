# Milestone 2.4: Game Logic

## Current Status
✅ Core Game Logic
- Word masking implemented in masking.ts
- Basic state management done in state.ts
- Initial API routes working in route.ts and guess/route.ts

## Required Fixes ✅

### 1. Progress & Win Condition Consistency
- [x] Remove duplicate progress computation from computations.ts
  - [x] Delete computeProgress function from computations.ts
  - [x] Update any imports to use state.ts version
  - [x] Update tests to use correct progress calculation
- [x] Fix incorrect win condition in computeGameProgress
  - [x] Remove isComplete from computeGameProgress
  - [x] Update any code using this incorrect win condition
  - [x] Add tests to verify win condition logic

### 2. Centralize Game Logic
- [x] Move all game computations to state.ts
  - [x] Move computeGuessCorrectness to state.ts
  - [x] Update imports in all files
  - [x] Remove duplicate code from computations.ts
- [x] Remove unnecessary code
  - [x] Remove RevealThresholds interface
  - [x] Remove DEFAULT_THRESHOLDS constant
  - [x] Update function signatures

### 3. Fix Reveal Logic ✅
- [x] Fix computeRevealState to use win condition
  - [x] Remove progress threshold-based reveals
  - [x] Only reveal content on game completion
  - [x] Add tests for reveal state logic
- [x] Remove computations.ts
  - [x] Update imports to use state.ts directly
  - [x] Delete the file
  - [x] Verify no breaking changes

### Implementation Steps
1. ✅ Update state.ts to be the single source of truth
2. ✅ Remove duplicate logic from computations.ts
3. ✅ Update all imports to use state.ts
4. ✅ Add/update tests to verify changes
5. ✅ Convert computations.ts to re-export from state.ts
6. ✅ Fix reveal state computation
7. ✅ Remove computations.ts file

## Implementation Details

### Progress Tracking
```typescript
interface Progress {
  titleArtist: number;  // Progress on title and artist words
  lyrics: number;       // Progress on lyrics words
  overall: number;      // Max of titleArtist and lyrics
}
```

### Reveal Logic
Content is only revealed when the game is complete:
- Win condition must be met: (title AND artist complete) OR (80% lyrics found)
- On win: reveal both Spotify and Genius content
- Before win: only show masked content
- No partial reveals based on progress

### Win Conditions
- Title AND artist complete (100% of title/artist words)
- OR 80% of lyrics words found

### Error Handling
- 404: Game not found
- 404: Song data not found
- 404: Lyrics not found
- 400: Invalid request body
- 500: Internal server error

## Dependencies
- Kept existing database operations
- Maintained backward compatibility
- Added proper error handling
- Added input validation with zod

## Status: COMPLETED ✅
All tasks have been implemented and verified with passing tests.